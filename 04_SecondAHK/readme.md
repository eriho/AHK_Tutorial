# AHKで色々やってみよう(その1)

## はじめに

前回でAHKの基本的な文法や命令を学びました。もちろんAHKでできることはそれだけではありません！今回は**エクセルで作成した複数の図をワードの表に貼り付ける**自動化に挑戦したいと思います。その中で以下のnew topicsを取り上げます。

* アプリケーション(ワード⇔エクセル)の切り替え
* マウス操作
* 繰り返し命令(ループ構文)

## AHKコードの実行内容

以下のことをAHKによって行います。

* エクセルの図の上にマウスカーソルを動かしクリップボードにコピー
* エクセルからワードにアクティブなウィンドウを切り替え
* 貼り付けたいワードの表にカーソルを移動
* 「形式を選択して貼り付け」で拡張メタファイルを選択して貼り付け
* エクセルに戻って次の図を選択し同様のことを繰り返す

![excelPasteToWordManyFig](./png/excelToWordPaste.gif)

マウスの動きが素早すぎて(またgifでフレームが間引いているので)、はっきり見えないかもしれませんが、エクセルがアクティブな時にはマウスが動いています。ワードでは表を右上から左下まで順に移動してペーストしているのが分かると思います。

## サンプルコード

サンプルコードを以下に示します。[こちら]()からダウンロードもできます。

いきなり長いコードに圧倒されるかもしれませんが、一つずつ見ていきましょう。

```AutoHotkey:

#p::
	pause

#k::
{
; 前提の準備
; excelから初めること
; excelでalt+tabを押すとwordに行くようにしておく
; wordの表では1つめの表にカーソルを合わせておく

	startX := 130
	startY := 630
	intervalX := 700
	intervalY := 400
	st := 800
	totalCount :=1

	Loop, 2{

		; y座標の設定。外のループはexcelシートのグラフ行列の行を動く
		thisY := startY + intervalY * (A_Index - 1)

		Loop, 3{

		; x座標の設定。外のループはexcelシートのグラフ行列の列を動く
			thisX := startX + intervalX * (A_Index - 1)

			IfWinExist, ahk_class XLMAIN
				{
				WinActivate, ahk_class XLMAIN
					; グラフをマウスクリックする
					mouseclick, Left, thisX, thisY
					; ctrl-cしてグラフをコピー
					send, ^c
					sleep, st
					; alt+tabでアプリケーション切り替えてwordにする
					}

			; word側で貼り付け
			WinActivate, ahk_exe WINWORD.EXE
			sleep, st
	
			; alt+hvsで形式を選択して貼り付けをよびだす
			send, !hvs
			sleep, st
			

			; 形式を選択して貼り付けで矢印上を四回押すと
			; 拡張メタファイルで貼り付けが選択され、enterを押してペースト
			Loop, 4{
			send, {up}
			sleep, st
			}
			send, {enter}
			sleep, st

			; wordの表で選択している表を移動するためにtabを押す。
			; 繰り返し回数が2で割り切れる時は名前を飛ばさないといけないので
			; tabを3回入力する。割り切れない時はtabを一回押す。

			if (mod(totalCount, 2 ) = 0 ){
				Loop, 3{
				send, {tab}
				}
				}
			else{
			send, {tab}
			}

			; 総繰り返し回数を保存する。上記の表移動回数の設定に使用する。
			totalCount := totalCount + 1

			WinActivate, ahk_class XLMAIN
			sleep, st

		}
	
	}

return

}

```

### いつでも中断できるようにしておこう

AHKのコードを書き終わり実行テストしてみると、全く意図したものと違う動作をする時はよくあります。この原因として一番多いのは、自分のやりたいことが、コードに論理的に反映されていない場合です。もちろんコードを書く人は自分なりに正しいと思うコードを書くわけですが、正しいかどうか頭の中で考えるよりも、実際に動かしてみてどのような挙動を示すのか実験する方が早い場合が多々あります。

そのため、実験はAHKにおいても素早くコードを完成させるための重要なステップですが、特にどう動くかわからないコードをとりあえず実行したら、びっくりしてしまうような挙動を始めてしまうかもしれません。AHKはキーを送るためのコードなので、なにかしらのウィンドウズ操作が実行されることになり、それが運悪くファイルの保存などを実施してしまうこともありえます。つまり、実験は必要だが、失敗したと分かったらすぐに中断できるようにしておかなければ、恐ろしくて実験できない、ということです。

もちろんAHKには実行中のコードを即中断するための命令が用意されています。なので、新しいコードを書く時には、`pause`コマンドを実行できるようにしておきましょう。

```
#p:: pause
```
winキー+pを押すと、実行中のコードがすぐに中断されます。あくまで中断であり終了ではないので、もう一度winキー+pを押すと、中断したコードが再開されることになります。

コードを実験する時は、win+Pをいつでも押せるように準備して、実行状況を見守るようにしましょう。



